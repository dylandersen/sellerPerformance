<template>
  <lightning-card>
    <div slot="title">
      <div class="custom-header">
        <div class="icon-container">
          <lightning-icon
            icon-name="utility:user"
            size="small"
            class="header-icon"
          >
          </lightning-icon>
        </div>
        <div class="title-container">
          <h2 class="card-title">Seller Performance</h2>
          <div class="powered-by">Powered by <b>Agentforce âœ¨</b></div>
        </div>
      </div>
    </div>
    <div slot="actions">
      <lightning-button
        label="âœ¨"
        title="AI-Powered Refresh"
        onclick={handleRefresh}
        disabled={isLoading}
        variant="neutral"
        class="refresh-button"
      >
      </lightning-button>
    </div>

    <div class="slds-p-around_medium">
      <!-- Loading State -->
      <template lwc:if={isLoading}>
        <div class="loading-container">
          <img src={agentforceIcon} alt="Agentforce" class="agentforce-icon" />
          <div class="spinner"></div>
          <p class="loading-text">{currentLoadingMessage}</p>
        </div>
      </template>

      <!-- Empty State -->
      <template lwc:if={showEmptyState}>
        <div class="slds-text-align_center slds-p-around_large">
          <p class="slds-text-heading_small empty-state-text">
            Click the âœ¨ button to let Agentforce analyze your seller performance
          </p>
        </div>
      </template>

      <!-- Error State -->
      <template lwc:if={hasError}>
        <div class="slds-box slds-theme_error slds-m-bottom_medium">
          <p class="slds-text-color_error">{errorMessage}</p>
        </div>
      </template>

      <!-- Performance Status Section - Modern Design -->
      <template lwc:if={hasData}>
        <div class="health-overview-container slds-m-bottom_large">
          <!-- Left: Circular Progress Gauge -->
          <div class="health-gauge-section">
            <div class="gauge-wrapper">
              <div class="circular-progress-container">
                <svg
                  class="circular-progress"
                  width="160"
                  height="160"
                  viewBox="0 0 160 160"
                >
                  <!-- Background circle -->
                  <circle
                    cx="80"
                    cy="80"
                    r="70"
                    fill="none"
                    stroke="#e5e5e5"
                    stroke-width="8"
                  ></circle>
                  <!-- Progress circle -->
                  <circle
                    cx="80"
                    cy="80"
                    r="70"
                    fill="none"
                    stroke={scoreColor}
                    stroke-width="8"
                    stroke-linecap="round"
                    stroke-dasharray={progressDashArray}
                    stroke-dashoffset={progressDashOffset}
                    transform="rotate(-90 80 80)"
                    class="progress-ring"
                  ></circle>
                </svg>
                <div class="gauge-content">
                  <div class="score-large">{performanceData.score}</div>
                  <div class="score-denominator">/100</div>
                </div>
              </div>
              <div class="gauge-label">
                <div>PERFORMANCE</div>
                <div>SCORE</div>
              </div>
              <!-- Score Tooltip -->
              <div class="score-tooltip">
                <div class="tooltip-header">
                  <lightning-icon
                    icon-name="utility:info_alt"
                    size="xx-small"
                    class="tooltip-icon"
                  ></lightning-icon>
                  <span>How is this score calculated?</span>
                </div>
                <div class="tooltip-content">
                  Agentforce analyzes activity volume (30%), pipeline health
                  (25%), deal execution (25%), and relationship building (20%).
                  The score provides a comprehensive view of your sales
                  performance.
                </div>
              </div>
            </div>
          </div>

          <!-- Right: 2x2 Grid for Status, Trend, Pipeline Health, Deal Velocity -->
          <div class="health-details-section">
            <div class="health-assessment-wrapper">
              <div class="status-card">
                <div class="status-header">
                  <span>Health Assessment</span>
                  <button 
                    class="info-button" 
                    onclick={toggleHealthAssessment}
                    title="Click for details"
                  >
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="info-icon"
                    ></lightning-icon>
                  </button>
                </div>
                <div class={performanceStatusClass} data-class="health-status-modern">
                  <span class="status-emoji-large">{performanceEmoji}</span>
                  <div class="status-content">
                    <span class="status-text-large">{performanceData.performanceStatus}</span>
                    <span class="status-explanation">{statusExplanation}</span>
                  </div>
                </div>
                <!-- Expandable Health Assessment Details -->
                <template lwc:if={showHealthAssessmentDetails}>
                  <div class={healthAssessmentDetailsClass}>
                    <div class="details-header">
                      <lightning-icon
                        icon-name="utility:info_alt"
                        size="xx-small"
                        class="details-icon"
                      ></lightning-icon>
                      <span>Health Assessment Details</span>
                    </div>
                    <div class="details-content">
                      <lightning-formatted-rich-text
                        value={healthAssessmentTooltip}
                      ></lightning-formatted-rich-text>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div class="trend-wrapper" data-trend={trendClass}>
              <div class="trend-card">
                <div class="trend-header">
                  <span>30-Day Trend</span>
                  <button 
                    class="info-button" 
                    onclick={toggleTrend}
                    title="Click for details"
                  >
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="info-icon"
                    ></lightning-icon>
                  </button>
                </div>
                <div class={trendClass} data-class="health-trend-modern">
                  <lightning-icon
                    icon-name={trendIcon}
                    size="small"
                    class="trend-icon"
                  ></lightning-icon>
                  <div class="trend-content">
                    <span class="trend-text">
                      <lightning-formatted-rich-text
                        value={trendLabel}
                      ></lightning-formatted-rich-text>
                    </span>
                    <span class="trend-explanation">{trendExplanation}</span>
                  </div>
                </div>
                <!-- Expandable Trend Details -->
                <template lwc:if={showTrendDetails}>
                  <div class={trendDetailsClass}>
                    <div class="details-header">
                      <lightning-icon
                        icon-name="utility:info_alt"
                        size="xx-small"
                        class="details-icon"
                      ></lightning-icon>
                      <span>30-Day Trend Details</span>
                    </div>
                    <div class="details-content">
                      <lightning-formatted-rich-text
                        value={trendTooltip}
                      ></lightning-formatted-rich-text>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div class="pipeline-health-wrapper">
              <div class="stage-card pipeline-health-card">
                <div class="stage-header">Pipeline Health</div>
                <div class="pipeline-health-content">
                  <div class="pipeline-stats">
                    <span class="pipeline-healthy">{healthyDealsCount} healthy</span>
                    <span class="pipeline-divider">â€¢</span>
                    <span class="pipeline-atrisk" style={atRiskTextStyle}>{atRiskDealsCount} at-risk</span>
                  </div>
                  <div class="pipeline-bar-container">
                    <div class="pipeline-bar-healthy" style={pipelineHealthyBarStyle}></div>
                    <div class="pipeline-bar-atrisk" style={pipelineAtRiskBarStyle}></div>
                  </div>
                  <div class="pipeline-explanation">{pipelineHealthExplanation}</div>
                </div>
              </div>
              <!-- Pipeline Health Tooltip -->
              <template lwc:if={pipelineHealthTooltip}>
                <div class="metric-tooltip pipeline-health-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Pipeline Health Focus</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={pipelineHealthTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="velocity-wrapper">
              <div class="closedate-card velocity-card">
                <div class="closedate-header">Deal Velocity</div>
                <div class="velocity-content">
                  <div class="velocity-main">
                    <span class="velocity-value">{dealVelocityFormatted}</span>
                    <span class={velocityBadgeClass}>{velocityStatus}</span>
                  </div>
                  <div class="velocity-explanation">Avg. days between stage changes</div>
                </div>
              </div>
              <!-- Deal Velocity Tooltip -->
              <template lwc:if={dealVelocityTooltip}>
                <div class="metric-tooltip deal-velocity-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Deal Velocity Calculation</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={dealVelocityTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Performance Metrics Grid -->
        <div class="slds-m-bottom_medium">
          <h3 class="slds-text-heading_small slds-m-bottom_x-small">
            ðŸ“Š Performance Metrics (Last 30 Days)
          </h3>
          <div class="metrics-grid">
            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:call"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{callCount}</div>
                <div class="metric-label">Calls</div>
              </div>
              <!-- Calls Tooltip -->
              <template lwc:if={callsTooltip}>
                <div class="metric-tooltip calls-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Call Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={callsTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:email"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{emailCount}</div>
                <div class="metric-label">Emails</div>
              </div>
              <!-- Emails Tooltip -->
              <template lwc:if={emailsTooltip}>
                <div class="metric-tooltip emails-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Email Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={emailsTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:event"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{meetingCount}</div>
                <div class="metric-label">Meetings</div>
              </div>
              <!-- Meetings Tooltip -->
              <template lwc:if={meetingsTooltip}>
                <div class="metric-tooltip meetings-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Meeting Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={meetingsTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:task"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{taskCount}</div>
                <div class="metric-label">Tasks</div>
              </div>
              <!-- Tasks Tooltip -->
              <template lwc:if={tasksTooltip}>
                <div class="metric-tooltip tasks-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Task Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={tasksTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:opportunity"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{totalPipelineValueFormatted}</div>
                <div class="metric-label">Pipeline Value</div>
              </div>
              <!-- Pipeline Value Tooltip -->
              <template lwc:if={pipelineValueTooltip}>
                <div class="metric-tooltip pipeline-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Pipeline Breakdown</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={pipelineValueTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:metrics"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{winRateFormatted}</div>
                <div class="metric-label">Win Rate</div>
              </div>
              <!-- Win Rate Tooltip -->
              <template lwc:if={winRateTooltip}>
                <div class="metric-tooltip winrate-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Win Rate Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={winRateTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:currency"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{totalRevenueFormatted}</div>
                <div class="metric-label">Total Revenue</div>
              </div>
              <!-- Revenue Tooltip -->
              <template lwc:if={revenueTooltip}>
                <div class="metric-tooltip revenue-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Revenue Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={revenueTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>

            <div class="metric-card-wrapper">
              <div class="metric-card">
                <lightning-icon
                  icon-name="standard:contact"
                  size="small"
                ></lightning-icon>
                <div class="metric-value">{contactsEngagedCount}</div>
                <div class="metric-label">Contacts Engaged</div>
              </div>
              <!-- Contacts Engaged Tooltip -->
              <template lwc:if={contactsEngagedTooltip}>
                <div class="metric-tooltip contacts-tooltip">
                  <div class="tooltip-header">
                    <lightning-icon
                      icon-name="utility:info_alt"
                      size="xx-small"
                      class="tooltip-icon"
                    ></lightning-icon>
                    <span>Contacts Details</span>
                  </div>
                  <div class="tooltip-content">
                    <lightning-formatted-rich-text
                      value={contactsEngagedTooltip}
                    ></lightning-formatted-rich-text>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Key Insights and Recommended Actions - Side by Side -->
        <template lwc:if={hasInsightsOrActions}>
          <div class="insights-actions-container slds-m-bottom_medium">
            <!-- Key Insights Section -->
            <template lwc:if={hasKeyInsights}>
              <div class="insights-column">
                <h3 class="slds-text-heading_small slds-m-bottom_x-small">
                  ðŸ’¡ Key Insights
                </h3>
                <ul class="slds-list_dotted">
                  <template
                    for:each={performanceData.keyInsights}
                    for:item="insight"
                  >
                    <li key={insight} class="insight-item">
                      <lightning-formatted-rich-text
                        value={insight}
                      ></lightning-formatted-rich-text>
                    </li>
                  </template>
                </ul>
              </div>
            </template>

            <!-- Recommended Actions Section -->
            <template lwc:if={hasRecommendedActions}>
              <div class="actions-column">
                <h3 class="slds-text-heading_small slds-m-bottom_x-small">
                  ðŸŽ¯ Recommended Actions
                </h3>
                <ul class="slds-list_dotted">
                  <template
                    for:each={performanceData.recommendedActions}
                    for:item="action"
                  >
                    <li key={action} class="action-item">
                      <lightning-formatted-rich-text
                        value={action}
                      ></lightning-formatted-rich-text>
                    </li>
                  </template>
                </ul>
              </div>
            </template>
          </div>
        </template>

        <!-- AI Disclaimer -->
        <div class="slds-m-top_medium">
          <div
            class="slds-scoped-notification slds-media slds-media_center ai-disclaimer"
            role="status"
          >
            <div class="slds-media__figure">
              <lightning-icon
                icon-name="utility:info"
                size="x-small"
                class="disclaimer-icon"
              ></lightning-icon>
            </div>
            <div class="slds-media__body">
              <p class="disclaimer-text">
                Agentforce uses generative AI, which can include inaccurate or
                harmful responses. Before sharing externally, review the output
                for accuracy and safety.
              </p>
            </div>
          </div>
        </div>
      </template>
    </div>
  </lightning-card>
</template>
